<!doctype html>
<html lang="zh-Hant">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LINE WebView 自我測試頁 / Self-Test</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#94a3b8; --ok:#22c55e; --fail:#ef4444; --warn:#f59e0b; }
    html,body{background:var(--bg);color:var(--fg);font:14px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";}
    .container{max-width:1000px;margin:32px auto;padding:0 16px;}
    h1{font-size:24px;margin:0 0 8px;}
    h2{font-size:18px;margin:24px 0 8px;border-left:3px solid #334155;padding-left:8px;}
    p{color:var(--muted);margin:6px 0 14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;margin:12px 0;}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{display:inline-block;border-radius:10px;border:1px solid #334155;padding:8px 12px;color:var(--fg);text-decoration:none;background:#0b1220;cursor:pointer;font-weight:600}
.btn:hover{background:#111827}
button.btn{-webkit-appearance:none;appearance:none;background:#0b1220;color:var(--fg);border:1px solid #334155}
.btn:disabled,button.btn:disabled{opacity:.55;filter:grayscale(15%);cursor:not-allowed;color:var(--fg)}
    .btn:hover{background:#0b1220}
    code,pre{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:8px;}
    .kv{display:grid;grid-template-columns:200px 1fr;gap:8px;}
    .tag{display:inline-flex;align-items:center;gap:6px;border:1px solid #1f2937;border-radius:999px;padding:4px 10px;margin-right:6px}
    .ok{color:var(--ok)} .fail{color:var(--fail)} .warn{color:var(--warn)}
    .logbox{position:sticky;bottom:0;background:#000;border:1px solid #1f2937;border-radius:10px;padding:8px;max-height:40vh;overflow:auto;font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .small{font-size:12px;color:#9ca3af}
    .hr{height:1px;background:#1f2937;margin:12px 0}
  </style>
</head>
<body>
  <div class="container">
    <h1>LINE WebView 自我測試頁 <span class="small">(放到你的網域即可用)</span></h1>
    <p>這一頁幫你快速檢查：是否在 LINE 內建瀏覽器、UA、Cookie/SameSite、Storage、上傳/下載、WebRTC、外部開啟等常見地雷。
    <br>建議：在 <b>iOS/Android 的 LINE</b>、以及 <b>Chrome/Safari</b> 各測一次，並截圖/錄影保存結果。</p>

    <div id="env" class="card">
      <h2>1) 環境偵測</h2>
      <div class="kv mono">
        <div>User-Agent</div><div id="ua"></div>
        <div>是否在 LINE WebView</div><div id="isLine"></div>
        <div>平台</div><div id="platform"></div>
        <div>定位特徵</div><div id="hints"></div>
      </div>
      <div style="margin-top:10px">
        <a id="openExternal" class="btn" target="_blank" rel="noopener">用外部瀏覽器開啟此頁</a>
        <a id="openChromeAndroid" class="btn" href="#">（Android）嘗試用 Chrome 開</a>
      </div>
    </div>

    <div class="grid2">
      <div class="card" id="cookies">
        <h2>2) Cookie / SameSite 測試</h2>
        <p>跨站情境請使用 <code>SameSite=None; Secure</code>。WKWebView/ITP 可能限制第三方 Cookie。</p>
        <div class="row">
          <button class="btn" id="setCookie">設定測試 Cookie</button>
          <button class="btn" id="checkCookie">讀取 Cookie</button>
          <button class="btn" id="clearCookie">清除 Cookie</button>
        </div>
        <pre id="cookieResult" class="mono"></pre>
      </div>

      <div class="card" id="storage">
        <h2>3) Storage（localStorage / sessionStorage / IndexedDB）</h2>
        <div class="row">
          <button class="btn" id="testStorage">測試寫入/讀取</button>
          <button class="btn" id="clearStorage">清除</button>
        </div>
        <pre id="storageResult" class="mono"></pre>
      </div>
    </div>

    <div class="grid2">
      <div class="card" id="upload">
        <h2>4) 檔案上傳/拍照</h2>
        <p>某些 WebView 可能不支援拍照或檔案選擇器。</p>
        <input id="fileInput" type="file" accept="image/*" capture="environment" />
        <pre id="fileResult" class="mono"></pre>
      </div>

      <div class="card" id="download">
        <h2>5) 下載測試（Blob 下載 + inline 預覽）</h2>
        <div class="row">
          <button class="btn" id="genTxt">產生文字檔並下載</button>
          <button class="btn" id="genPdf">產生 PDF Blob 內嵌預覽</button>
        </div>
        <div id="downloadLinks" class="row" style="margin-top:8px"></div>
        <iframe id="pdfPreview" style="display:none;width:100%;height:300px;border:1px solid #1f2937;border-radius:10px"></iframe>
      </div>
    </div>

    <div class="grid2">
      <div class="card" id="webrtc">
        <h2>6) WebRTC / 裝置權限</h2>
        <div class="row">
          <button class="btn" id="checkDevices">列出媒體裝置</button>
          <button class="btn" id="askCamera">請求相機權限</button>
          <button class="btn" id="askMic">請求麥克風權限</button>
        </div>
        <pre id="webrtcResult" class="mono"></pre>
      </div>

      <div class="card" id="deeplink">
        <h2>7) 深連結 / App Links（展示）</h2>
        <p>以下僅示例。許多 WebView 會攔截自動跳 App，建議提供「外部開啟」。</p>
        <div class="row">
          <a class="btn" href="intent://maps.google.com/#Intent;scheme=https;package=com.google.android.apps.maps;end">Android intent:// 範例</a>
          <a class="btn" href="yourapp://open/somewhere">自訂 Scheme 範例</a>
          <a class="btn" href="https://your-universal-link.example.com/open">Universal Link 範例</a>
        </div>
        <p class="small">※ 請替換成你自家 App 的實際連結測試。</p>
      </div>
    </div>

    <div class="card">
      <h2>8) 內嵌即時 Log（無 DevTools 時很好用）</h2>
      <p>自動收集 <code>console.log/warn/error</code>、未捕捉錯誤與 Promise 拒絕。</p>
      <div id="log" class="logbox mono"></div>
    </div>

    <div class="small">版本 1.0 · 可自由複製修改 · 由測試頁自動產生的檢測結果僅供參考，實際限制依 LINE / OS 版本而異。</div>
  </div>

<script>
(function bootLog(){
  const box = document.getElementById('log');
  function write(kind, ...args){
    const ts = new Date().toISOString().replace('T',' ').replace('Z','');
    box.textContent += `[${ts}] [${kind}] ` + args.map(v => {
      try{ return typeof v==='object'? JSON.stringify(v): String(v);}catch(e){ return String(v); }
    }).join(' ') + '\n';
    box.scrollTop = box.scrollHeight;
  }
  ['log','warn','error'].forEach(k=>{
    const old = console[k].bind(console);
    console[k] = (...a)=>{ old(...a); write(k, ...a); };
  });
  window.addEventListener('error', e=> write('error','window.onerror', e.message, e.filename+':'+e.lineno));
  window.addEventListener('unhandledrejection', e=> write('error','unhandledrejection', String(e.reason)));
  write('log','Log viewer ready');
})();

(function env(){
  const ua = navigator.userAgent;
  const isLINE = /Line\/([\d.]+)/.test(ua);
  const m = ua.match(/Line\/([\d.]+)/);
  const inAppVer = m? m[1] : '—';
  const isIOS = /iPhone|iPad|iPod/i.test(ua);
  const isAndroid = /Android/i.test(ua);
  const hints = [];
  if (isIOS) hints.push('iOS/WKWebView 可能啟用 ITP');
  if (isAndroid) hints.push('Android WebView 基於 Chrome WebView');
  if (isLINE) hints.push('偵測到 LINE 內建瀏覽器，可能限制跳外部/下載');

  document.getElementById('ua').textContent = ua;
  document.getElementById('isLine').innerHTML = isLINE
    ? `<span class="tag warn">LINE WebView v${inAppVer}</span>`
    : '<span class="tag ok">否（非 LINE WebView）</span>';
  document.getElementById('platform').textContent = isIOS? 'iOS' : isAndroid? 'Android' : navigator.platform || 'Unknown';
  document.getElementById('hints').textContent = hints.join('；') || '—';

  // 外部開啟連結
  const selfUrl = location.href;
  const openExternal = document.getElementById('openExternal');
  openExternal.href = selfUrl;
  const openChromeAndroid = document.getElementById('openChromeAndroid');
  openChromeAndroid.addEventListener('click', (e)=>{
    e.preventDefault();
    const url = 'googlechrome://navigate?url=' + encodeURIComponent(selfUrl);
    location.href = url; // 可能被攔截，不保證
  });
  console.log('env ready');
})();

(function cookieTest(){
  const out = document.getElementById('cookieResult');
  function log(...a){ out.textContent += a.join(' ')+'\n'; }
  function setTest(){
    try{
      document.cookie = 'line_test_samesite=None; path=/; Secure; SameSite=None';
      document.cookie = 'line_test_lax=1; path=/; SameSite=Lax';
      document.cookie = 'line_test_strict=1; path=/; SameSite=Strict';
      log('已嘗試設定三種 Cookie（None/Lax/Strict）。');
    }catch(e){ log('設定失敗：', e.message); }
  }
  function read(){
    log('目前 cookie =', document.cookie || '(空)');
  }
  function clear(){
    ['line_test_samesite','line_test_lax','line_test_strict'].forEach(k=>{
      document.cookie = `${k}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT`;
    });
    log('已清除測試 Cookie');
  }
  document.getElementById('setCookie').onclick = setTest;
  document.getElementById('checkCookie').onclick = read;
  document.getElementById('clearCookie').onclick = clear;
  console.log('cookie test ready');
})();

(function storageTest(){
  const out = document.getElementById('storageResult');
  function log(...a){ out.textContent += a.join(' ')+'\n'; }
  document.getElementById('testStorage').onclick = async ()=>{
    try{
      localStorage.setItem('line_local','ok-'+Date.now());
      sessionStorage.setItem('line_session','ok-'+Date.now());
      log('localStorage =', localStorage.getItem('line_local'));
      log('sessionStorage =', sessionStorage.getItem('line_session'));
      // IndexedDB smoke test
      const db = await new Promise((resolve, reject)=>{
        const req = indexedDB.open('line_test_db', 1);
        req.onupgradeneeded = ()=> req.result.createObjectStore('kv');
        req.onsuccess = ()=> resolve(req.result);
        req.onerror = ()=> reject(req.error);
      });
      db.close();
      log('IndexedDB: 可開啟');
    }catch(e){ log('發生錯誤：', e.message); }
  };
  document.getElementById('clearStorage').onclick = ()=>{
    try{
      localStorage.removeItem('line_local');
      sessionStorage.removeItem('line_session');
      indexedDB.deleteDatabase('line_test_db');
      log('已清除 local/session/IndexedDB');
    }catch(e){ log('清除錯誤：', e.message); }
  };
  console.log('storage test ready');
})();

(function uploadTest(){
  const inp = document.getElementById('fileInput');
  const out = document.getElementById('fileResult');
  inp.addEventListener('change', ()=>{
    const f = inp.files && inp.files[0];
    out.textContent = f ? `已選擇：${f.name} (${f.type || 'unknown'}, ${f.size} bytes)` : '未選擇檔案';
  });
  console.log('upload test ready');
})();

(function downloadTest(){
  const links = document.getElementById('downloadLinks');
  const pdfFrame = document.getElementById('pdfPreview');
  document.getElementById('genTxt').onclick = ()=>{
    const blob = new Blob([`Hello from LINE test\n${new Date().toISOString()}`], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'line-webview-test.txt'; a.textContent = '下載文字檔'; a.className='btn';
    links.appendChild(a);
    console.log('提供文字檔下載連結（部分 WebView 可能忽略 download 屬性）');
  };
  document.getElementById('genPdf').onclick = ()=>{
    // 超簡易 PDF（二進位產生較繁瑣；這裡用 data URI / PDF 最小骨架）
    const base64 = btoa('%PDF-1.3\n1 0 obj<</Type/Catalog/Pages 2 0 R>>endobj\n2 0 obj<</Type/Pages/Count 1/Kids[3 0 R]>>endobj\n3 0 obj<</Type/Page/Parent 2 0 R/MediaBox[0 0 300 144]/Contents 4 0 R/Resources<</Font<</F1 5 0 R>>>>>>endobj\n4 0 obj<</Length 55>>stream\nBT /F1 18 Tf 30 100 Td (LINE WebView PDF Preview) Tj ET\nendstream\nendobj\n5 0 obj<</Type/Font/Subtype/Type1/BaseFont/Helvetica>>endobj\nxref\n0 6\n0000000000 65535 f \n0000000010 00000 n \n0000000053 00000 n \n0000000102 00000 n \n0000000241 00000 n \n0000000387 00000 n \ntrailer<</Size 6/Root 1 0 R>>\nstartxref\n505\n%%EOF');
    const pdfUrl = 'data:application/pdf;base64,'+base64;
    pdfFrame.style.display = 'block';
    pdfFrame.src = pdfUrl;
    console.log('已在頁面內嵌 PDF 預覽');
  };
  console.log('download test ready');
})();

(function webrtc(){
  const out = document.getElementById('webrtcResult');
  function log(...a){ out.textContent += a.join(' ')+'\n'; }
  document.getElementById('checkDevices').onclick = async ()=>{
    try{
      if (!navigator.mediaDevices?.enumerateDevices){ log('enumerateDevices 不可用'); return; }
      const devices = await navigator.mediaDevices.enumerateDevices();
      log('裝置數：', devices.length);
      devices.forEach(d=> log(`${d.kind}: ${d.label || '(無標籤)'} id=${d.deviceId.slice(0,6)}…`));
    }catch(e){ log('失敗：', e.message); }
  };
  document.getElementById('askCamera').onclick = async ()=>{
    try{
      await navigator.mediaDevices.getUserMedia({ video:true });
      log('相機：OK（已授權或成功要求）');
    }catch(e){ log('相機失敗：', e.message); }
  };
  document.getElementById('askMic').onclick = async ()=>{
    try{
      await navigator.mediaDevices.getUserMedia({ audio:true });
      log('麥克風：OK（已授權或成功要求）');
    }catch(e){ log('麥克風失敗：', e.message); }
  };
  console.log('webrtc test ready');
})();
</script>
</body>
</html>
